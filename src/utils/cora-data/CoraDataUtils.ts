import { isEqual as _isEqual } from 'lodash';
import { Attributes, DataAtomic, DataGroup } from './CoraData';

export function getFirstChildWithNameInData(
  dataGroup: DataGroup,
  nameInData: string,
): DataAtomic | DataGroup | null {
  if (dataGroup.children.length === 0) {
    return null;
  }

  const matchingChild = dataGroup.children.find((child) => {
    return child.name === nameInData;
  });

  if (matchingChild === undefined) {
    return null;
  }

  return matchingChild;
}

export function getAllChildrenWithNameInData(
  dataGroup: DataGroup,
  nameInData: string,
): (DataAtomic | DataGroup)[] {
  const childrenToReturn = dataGroup.children.filter((child) => {
    return child.name === nameInData;
  });

  return childrenToReturn;
}

export function getFirstDataAtomicWithNameInData(
  dataGroup: DataGroup,
  nameInData: string,
): DataAtomic | undefined {
  if (dataGroup.children.length === 0) {
    return undefined;
  }

  const dataAtomics = <DataAtomic[]>dataGroup.children.filter((child) => {
    return Object.prototype.hasOwnProperty.call(child, 'value');
  });

  const firstMatchingDataAtomic = dataAtomics.find((dataAtomic) => {
    return dataAtomic.name === nameInData;
  });

  return firstMatchingDataAtomic;
}

export function getAllDataAtomicsWithNameInData(
  dataGroup: DataGroup,
  nameInData: string,
): DataAtomic[] {
  const dataAtomics = <DataAtomic[]>dataGroup.children.filter((child) => {
    return Object.prototype.hasOwnProperty.call(child, 'value');
  });

  const matchingDataAtomics = dataAtomics.filter((dataAtomic) => {
    return dataAtomic.name === nameInData;
  });

  return matchingDataAtomics;
}

export function getFirstDataGroupWithNameInData(
  dataGroup: DataGroup,
  nameInData: string,
): DataGroup | undefined {
  const dataGroups = <DataGroup[]>dataGroup.children.filter((child) => {
    return Object.prototype.hasOwnProperty.call(child, 'children');
  });

  const firstMatchingDataGroup = dataGroups.find((child) => {
    return child.name === nameInData;
  });

  return firstMatchingDataGroup;
}

export function getFirstDataGroupWithNameInDataAndAttribues(
  dataGroup: DataGroup,
  nameInData: string,
  attributesToMatch?: Attributes,
): DataGroup | undefined {
  const matchingDataGroups = getAllDataGroupsWithNameInDataAndAttributes(
    dataGroup,
    nameInData,
    attributesToMatch,
  );

  if (matchingDataGroups.length === 0) {
    return undefined;
  }

  return matchingDataGroups[0];
}

export const getAllDataGroupsWithNameInDataAndAttributes = (
  dataGroup: DataGroup,
  nameInData: string,
  attributesToMatch?: Attributes,
): DataGroup[] => {
  const dataGroups = <DataGroup[]>dataGroup.children.filter((child) => {
    return Object.prototype.hasOwnProperty.call(child, 'children');
  });

  const matchingDataGroups = dataGroups.filter((child) => {
    const matchingNameInData = child.name === nameInData;
    let matchingAttributes = false;
    if (attributesToMatch === undefined && child.attributes === undefined) {
      return matchingNameInData;
    }
    if (attributesToMatch !== undefined && child.attributes !== undefined) {
      matchingAttributes = _isEqual(attributesToMatch, child.attributes);
    }

    return matchingAttributes && matchingNameInData;
  });

  return matchingDataGroups;
};

export default {
  getFirstChildWithNameInData,
  getAllChildrenWithNameInData,
  getFirstDataAtomicWithNameInData,
  getAllDataAtomicsWithNameInData,
  getFirstDataGroupWithNameInData,
  getFirstDataGroupWithNameInDataAndAttribues,
  getAllDataGroupsWithNameInDataAndAttributes,
};
